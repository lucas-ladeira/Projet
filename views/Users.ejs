<!DOCTYPE html>
<html lang="en">
<%- include('../components/head', { title: 'Users Management' }); %>

  <body>
    <%- include('../components/header', { role: 'admin' }); %>

      <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h1>Users Management</h1>
          <button class="btn btn-success" onclick="showAddForm()">
            <i class="bi bi-plus-lg"></i> Add New User
          </button>
        </div>
        <% if(users && users.length> 0) { %>
          <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover mb-5">
              <thead class="table-dark">
                <tr>
                  <th class="align-middle">Username</th>
                  <th class="align-middle">E-mail</th>
                  <th class="align-middle">Role</th>
                  <th class="align-middle">Actions</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <% users.forEach(user=> { %>
                  <tr>
                    <td class="align-middle">
                      <%= user.name %>
                    </td>
                    <td class="align-middle">
                      <%= user.email %>
                    </td>
                    <td class="align-middle">
                      <%= user.role==='admin' ? 'Admin' : 'User' %>
                    </td>
                    <td class="align-middle">
                      <button class="btn btn-warning btn-sm px-2 mx-1"
                        onclick="showEditForm('<%=user._id %>', '<%= user.name %>', '<%= user.email %>', '<%= user.password %>', '<%= user.role %>')">
                        <i class="bi bi-pencil"></i> Edit
                      </button>
                      <% if(user.role!=='admin' ) { %>
                        <button type="submit" class="btn btn-danger btn-sm px-2 mx-1"
                          onclick="confirmDelete('<%= user.id %>', '<%= user.name %>')">
                          <i class="bi bi-trash3"></i> Delete
                        </button>
                        <% } else { %>
                          <button type="submit" class="btn btn-secondary btn-sm px-2 mx-1" disabled>
                            <i class="bi bi-trash3"></i> Delete
                          </button>
                          <% } %>
                    </td>
                  </tr>
                  <% }); %>
              </tbody>
            </table>
          </div>
          <% } else { %>
            <div id="noUsersMessage" class="alert alert-info">
              No users found. Click "Add New User" to create one.
            </div>
            <% } %>
      </div>


      <div class="overlay" id="overlay"></div>

      <!-- User Form Modal -->
      <div id="userForm" class="modal-content">
        <h2 id="formTitle" class="mb-4">Add New User</h2>
        <form id="userFormElement" action="/admin/users" method="POST">
          <input type="hidden" id="userId" name="id">
          <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input type="text" class="form-control" id="name" name="name" required minlength="2" maxlength="50"
              placeholder="Enter name">
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">E-mail</label>
            <input type="email" class="form-control" id="email" name="email" required placeholder="Enter email">
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" name="password" required
              placeholder="Enter password">
          </div>
          <div class="mb-3">
            <label for="role" class="form-label" id="roleLabel">Role</label>
            <select class="form-select" id="role" name="role" required>
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" onclick="hideForm()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>

      <!-- Delete Confirmation Modal -->
      <div id="deleteConfirmationModal" class="modal-content" style="display: none;">
        <h2 class="mb-2">Confirm Deletion</h2>
        <p id="deleteMessage"></p>
        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
          <form id="deleteForm" method="POST">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </div>
      </div>
      <button onclick="showLocalStorage()">click me to show local storage</button>
      <div>
        <textarea name="" id="anything"></textarea>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

      <script>
        function showLocalStorage() {
          document.getElementById('anything').value = localStorage.getItem("cart");
        }
        function showAddForm() {
          document.getElementById('userFormElement').action = '/admin/users';
          document.getElementById('userId').value = '';
          document.getElementById('name').value = '';
          document.getElementById('email').value = '';
          document.getElementById('password').value = '';
          document.getElementById('password').required = true;
          document.getElementById('roleLabel').hidden = true;
          document.getElementById('role').hidden = true;
          document.getElementById('formTitle').innerText = 'Add New User';
          document.getElementById('userForm').style.display = 'block';
          document.getElementById('overlay').style.display = 'block';
        }

        function showEditForm(id, name, email, password, role) {
          document.getElementById('userFormElement').action = `/admin/users/${id}?_method=PUT`;
          document.getElementById('userId').value = id;
          document.getElementById('name').value = name;
          document.getElementById('email').value = email;
          document.getElementById('password').value = '';
          document.getElementById('password').required = false;
          document.getElementById('role').value = role;
          document.getElementById('roleLabel').hidden = false;
          document.getElementById('role').hidden = false;
          document.getElementById('formTitle').innerText = 'Edit User';
          document.getElementById('userForm').style.display = 'block';
          document.getElementById('overlay').style.display = 'block';
        }

        function confirmDelete(userId, userName) {
          document.getElementById('deleteMessage').innerHTML =
            `Do you really want to delete user <b>${userName}</b>?`;

          document.getElementById('deleteForm').action = `/admin/users/${userId}?_method=DELETE`;

          document.getElementById('deleteConfirmationModal').style.display = 'block';
          document.getElementById('overlay').style.display = 'block';
        }

        function hideDeleteModal() {
          document.getElementById('deleteConfirmationModal').style.display = 'none';
          document.getElementById('overlay').style.display = 'none';
        }

        function hideForm() {
          document.getElementById('userForm').style.display = 'none';
          document.getElementById('overlay').style.display = 'none';
        }

        document.getElementById('overlay').addEventListener('click', function () {
          const deleteModal = document.getElementById('deleteConfirmationModal');
          const userFormModal = document.getElementById('userForm');

          if (userFormModal.style.display === 'block') {
            hideForm();
          }
          else if (deleteModal.style.display === 'block') {
            hideDeleteModal();
          }
        });
      </script>
  </body>

</html>