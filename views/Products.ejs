<!DOCTYPE html>
<html lang="en">
<%- include('../components/head', { title: 'Products Management' }); %>

  <body>
    <%- include('../components/header', { role: 'admin' }); %>
      <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h1>Products Management</h1>
          <button class="btn btn-success" onclick="showAddForm()">
            <i class="bi bi-plus-lg"></i> Add New Product
          </button>
        </div>

        <% if (products && products.length> 0) { %>
          <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover mb-5">
              <thead class="table-dark">
                <tr>
                  <th class="align-middle">Image</th>
                  <th class="align-middle">Name</th>
                  <th class="align-middle">Price</th>
                  <th class="align-middle">Description</th>
                  <th class="align-middle">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% products.forEach(product=> { %>
                  <tr>
                    <td class="align-middle">
                      <img src="<%= product.image %>" alt="<%= product.name %>" class="product-image"
                        style="width: 100px; height: auto;">
                    </td>
                    <td class="align-middle">
                      <%= product.name %>
                    </td>
                    <td class="align-middle">
                      <%= product.price.toFixed(2) %> $
                    </td>
                    <td class="align-middle">
                      <%= product.description %>
                    </td>
                    <td class="align-middle">
                      <button class="btn btn-warning btn-sm"
                        onclick="showEditForm('<%= product._id %>', '<%= product.name %>', '<%= product.description %>', '<%= product.price %>', '<%= product.image %>')">
                        <i class="bi bi-pencil"></i> Edit
                      </button>
                      <button class="btn btn-danger btn-sm"
                        onclick="confirmDelete('<%= product._id %>', '<%= product.name %>')">
                        <i class="bi bi-trash3"></i> Delete
                      </button>
                    </td>
                  </tr>
                  <% }); %>
              </tbody>
            </table>
          </div>
          <% } else { %>
            <div id="noProductsMessage" class="alert alert-info">
              No products found. Click "Add New Product" to create one.
            </div>
            <% } %>
      </div>

      <!-- Overlay -->
      <div class="overlay" id="overlay" style="display: none;"></div>

      <!-- Product Form Modal -->
      <div id="productForm" class="modal-content" style="display: none;">
        <h2 id="formTitle" class="mb-4">Add New Product</h2>
        <form id="productFormElement" action="/admin/products" method="POST" enctype="multipart/form-data">
          <input type="hidden" id="productId" name="id">
          <div class="mb-3">
            <label for="productName" class="form-label">Name</label>
            <input type="text" class="form-control" id="productName" name="name" required
              placeholder="Enter product name">
          </div>
          <div class="mb-3">
            <label for="productDescription" class="form-label">Description</label>
            <input type="text" class="form-control" id="productDescription" name="description" required
              placeholder="Enter description">
          </div>
          <div class="mb-3">
            <label for="productPrice" class="form-label">Price</label>
            <input type="number" class="form-control" id="productPrice" name="price" required placeholder="Enter price"
              step="0.01">
          </div>

          <!-- Existing Image Section -->
          <div class="mb-3" id="existingImageContainer" style="display: none;">
            <label class="form-label">Existing Image</label>
            <div>
              <img id="existingImage" src="" alt="Existing Image"
                style="width: 100px; height: auto; margin-bottom: 10px;">
            </div>
            <small class="text-muted">Upload a new image to replace the existing one.</small>
          </div>

          <!-- Upload New Image Section -->
          <div class="mb-3">
            <label for="productImage" class="form-label">Upload New Image</label>
            <input type="file" class="form-control" id="productImage" name="image" accept="image/*">
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" onclick="hideForm()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>


      <!-- Delete Confirmation Modal -->
      <div id="deleteConfirmationModal" class="modal-content" style="display: none;">
        <h2 class="mb-2">Confirm Deletion</h2>
        <p id="deleteMessage"></p>
        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
          <form id="deleteForm" method="POST">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </div>
      </div>

      <!-- Scripts -->
      <script>
        function showAddForm() {
          document.getElementById('productFormElement').action = '/admin/products';
          document.getElementById('productId').value = '';
          document.getElementById('productName').value = '';
          document.getElementById('productDescription').value = '';
          document.getElementById('productPrice').value = '';
          document.getElementById('productImage').value = '';
          document.getElementById('formTitle').innerText = 'Add New Product';
          document.getElementById('productForm').style.display = 'block';
          document.getElementById('overlay').style.display = 'block';
        }

        function showEditForm(id, name, description, price, image) {
          document.getElementById('productFormElement').action = `/admin/products/${id}?_method=PUT`;
          document.getElementById('productId').value = id;
          document.getElementById('productName').value = name;
          document.getElementById('productDescription').value = description;
          document.getElementById('productPrice').value = price;

          // Affiche un aper√ßu de l'image existante si elle existe
          if (image) {
            document.getElementById('existingImage').src = image;
            document.getElementById('existingImageContainer').style.display = 'block';
          } else {
            document.getElementById('existingImageContainer').style.display = 'none';
          }

          document.getElementById('formTitle').innerText = 'Edit Product';
          document.getElementById('productForm').style.display = 'block';
          document.getElementById('overlay').style.display = 'block';
        }


        function confirmDelete(productId, productName) {
          document.getElementById('deleteMessage').innerHTML =
            `Do you really want to delete product <b>${productName}</b>?`;

          document.getElementById('deleteForm').action = `/admin/products/${productId}?_method=DELETE`;
          document.getElementById('deleteConfirmationModal').style.display = 'block';
          document.getElementById('overlay').style.display = 'block';
        }

        function hideDeleteModal() {
          document.getElementById('deleteConfirmationModal').style.display = 'none';
          document.getElementById('overlay').style.display = 'none';
        }

        function hideForm() {
          document.getElementById('productForm').style.display = 'none';
          document.getElementById('overlay').style.display = 'none';
        }

        document.getElementById('overlay').addEventListener('click', function () {
          hideForm();
          hideDeleteModal();
        });
      </script>

      <!-- Bootstrap and Icons -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

  </body>

</html>